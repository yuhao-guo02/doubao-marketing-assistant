<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美团AI营销助手 - 多渠道版本</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* 美团品牌色系 */
            --meituan-yellow: #FFC300;
            --meituan-orange: #FF6B35;
            --meituan-red: #FF4757;
            --meituan-green: #2ED573;
            --meituan-blue: #3742FA;
            --meituan-purple: #5F27CD;
            
            /* 功能区域色彩 */
            --input-section: #FFF8E1;
            --result-section: #E3F2FD;
            --analysis-section: #F3E5F5;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --info-color: #2196F3;
        }
        
        body {
            background: linear-gradient(135deg, var(--meituan-yellow) 0%, var(--meituan-orange) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            padding: 3rem !important;
        }
        
        /* 输入区域 - 黄色主题 */
        .input-section {
            background: linear-gradient(135deg, var(--input-section) 0%, #FFF3E0 100%);
            border-left: 6px solid var(--meituan-yellow);
            padding: 2.5rem !important;
            margin-bottom: 1rem;
        }
        
        /* 结果展示区域 - 蓝色主题 */
        .result-section {
            background: linear-gradient(135deg, var(--result-section) 0%, #E1F5FE 100%);
            border-left: 6px solid var(--meituan-blue);
            padding: 2.5rem !important;
            margin-bottom: 2rem;
        }
        
        /* 数据分析区域 - 紫色主题 */
        .analysis-section {
            background: linear-gradient(135deg, var(--analysis-section) 0%, #F1E8FF 100%);
            border-left: 6px solid var(--meituan-purple);
            padding: 2.5rem !important;
            margin-bottom: 2rem;
        }
        
        .feature-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--meituan-yellow), var(--meituan-orange));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .feature-card:hover::before {
            transform: scaleX(1);
        }
        
        /* 卡片内容动画 */
        .feature-card .card-content {
            transition: all 0.3s ease;
        }
        
        .feature-card:hover .card-content {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--meituan-yellow), var(--meituan-orange));
            border: none;
            border-radius: 30px;
            padding: 15px 35px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, var(--meituan-orange), var(--meituan-red));
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 195, 0, 0.3);
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        .btn-outline-primary {
            border-color: var(--meituan-yellow);
            color: var(--meituan-orange);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--meituan-yellow);
            border-color: var(--meituan-yellow);
            color: white;
        }
        
        .btn-outline-secondary {
            border-color: var(--meituan-blue);
            color: var(--meituan-blue);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--meituan-blue);
            border-color: var(--meituan-blue);
            color: white;
        }
        
        .btn-outline-info {
            border-color: var(--meituan-green);
            color: var(--meituan-green);
        }
        
        .btn-outline-info:hover {
            background-color: var(--meituan-green);
            border-color: var(--meituan-green);
            color: white;
        }
        
        .btn-outline-orange {
            border-color: var(--meituan-orange);
            color: var(--meituan-orange);
            transition: all 0.3s ease;
        }
        
        .btn-outline-orange:hover {
            background-color: var(--meituan-orange);
            border-color: var(--meituan-orange);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .form-control, .form-select {
            border-radius: 18px;
            border: 2px solid #e9ecef;
            padding: 18px 25px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--meituan-yellow);
            box-shadow: 0 0 0 0.3rem rgba(255, 195, 0, 0.2);
            transform: translateY(-2px);
            background: white;
        }
        
        .form-control:hover, .form-select:hover {
            border-color: var(--meituan-orange);
            transform: translateY(-1px);
        }
        
        .result-area {
            background: linear-gradient(135deg, #F8F9FA 0%, #E3F2FD 100%);
            border-radius: 20px;
            padding: 2rem;
            min-height: 250px;
            border: 3px dashed var(--meituan-blue);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .result-area:hover {
            border-color: var(--meituan-orange);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .generated-image {
            max-width: 100%;
            border-radius: 10px;
            display: block;
            object-fit: cover;
            width: 100%;
            height: auto;
        }
        
        .image-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .image-container:hover {
            transform: scale(1.01);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .feed-image-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            width: 100%;
            aspect-ratio: 1;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .feed-image-container:hover {
            transform: scale(1.01);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .feed-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .channel-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .channel-poster { 
            background: linear-gradient(45deg, var(--meituan-red), #FF6B6B); 
            color: white; 
        }
        
        .channel-banner { 
            background: linear-gradient(45deg, var(--meituan-green), #4ECDC4); 
            color: white; 
        }
        
        .channel-feed { 
            background: linear-gradient(45deg, var(--meituan-blue), #45B7D1); 
            color: white; 
        }
        
        /* 标题颜色 */
        .text-primary {
            color: var(--meituan-orange) !important;
        }
        
        /* 成功状态 */
        .text-success {
            color: var(--meituan-green) !important;
        }
        
        /* 警告状态 */
        .text-warning {
            color: var(--warning-color) !important;
        }
        
        /* 错误状态 */
        .text-danger {
            color: var(--error-color) !important;
        }
        
        /* 信息状态 */
        .text-info {
            color: var(--meituan-blue) !important;
        }
        
        /* 卡片背景色 */
        .bg-primary {
            background-color: var(--meituan-yellow) !important;
        }
        
        .bg-success {
            background-color: var(--meituan-green) !important;
        }
        
        .bg-warning {
            background-color: var(--warning-color) !important;
        }
        
        .bg-danger {
            background-color: var(--error-color) !important;
        }
        
        /* 表格样式 */
        .table-dark {
            background: linear-gradient(45deg, var(--meituan-orange), var(--meituan-red)) !important;
        }
        
        /* 进度条和加载动画 */
        .spinner-border.text-primary {
            color: var(--meituan-yellow) !important;
        }
        
        /* 徽章样式 */
        .badge.bg-warning {
            background-color: var(--meituan-yellow) !important;
            color: #333 !important;
        }
        
        .badge.bg-secondary {
            background-color: #6C757D !important;
        }
        
        /* 提示框样式 */
        .alert-info {
            background-color: rgba(33, 150, 243, 0.1);
            border-color: var(--meituan-blue);
            color: var(--meituan-blue);
        }
        
        .alert-warning {
            background-color: rgba(255, 152, 0, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }
        
        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            border-color: var(--meituan-green);
            color: var(--meituan-green);
        }
        
        .alert-danger {
            background-color: rgba(244, 67, 54, 0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        /* 加载动画增强 */
        .loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* 图标动画 */
        .fas {
            transition: all 0.3s ease;
        }
        
        .feature-card:hover .fas {
            transform: scale(1.1) rotate(5deg);
            color: var(--meituan-orange);
        }
        
        /* 表单组间距 */
        .mb-3 {
            margin-bottom: 1.5rem !important;
        }
        
        .mb-4 {
            margin-bottom: 2rem !important;
        }
        
        .mb-5 {
            margin-bottom: 3rem !important;
        }
        
        /* 卡片内容间距 */
        .p-4 {
            padding: 2rem !important;
        }
        
        /* 表格增强 */
        .table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(255, 195, 0, 0.1);
            transform: scale(1.005);
            transition: all 0.2s ease;
        }
        
        /* 图表容器增强 */
        .card {
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        
        /* 徽章动画 */
        .badge {
            transition: all 0.3s ease;
        }
        
        .badge:hover {
            transform: scale(1.05);
        }
        
        /* 页面加载动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .main-container {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .feature-card {
            animation: fadeInUp 0.8s ease-out;
            animation-delay: calc(var(--animation-order) * 0.1s);
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="main-container p-5" style="margin-bottom: 3rem;">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="fas fa-store text-primary me-3"></i>
                    美团AI营销助手
                </h1>
                <p class="lead text-muted mb-0">一键生成专业营销内容，助您省心省力</p>
            </div>

            <div class="row g-5">
                <!-- 商品信息输入 -->
                <div class="col-lg-12 mb-3">
                    <div class="feature-card p-4 input-section" style="--animation-order: 1;">
                        <div class="text-center mb-4">
                            <i class="fas fa-box fa-2x text-primary mb-3"></i>
                            <h3 class="h4">商品信息</h3>
                            <p class="text-muted">填写商品详细信息，选择渠道类型，AI将为您生成专业营销内容</p>
                        </div>
                        
                                                <form id="productForm">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="productName" class="form-label fw-bold">商品名称 *</label>
                                        <input type="text" class="form-control" id="productName" 
                                            placeholder="例如：小米智能电风扇" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="productCategory" class="form-label fw-bold">商品类别</label>
                                        <input type="text" class="form-control" id="productCategory" 
                                            placeholder="例如：家用电器、数码产品、服装等">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="productFeatures" class="form-label fw-bold">主要功能/卖点 *</label>
                                <textarea class="form-control" id="productFeatures" rows="3" 
                                    placeholder="请详细描述商品的主要功能、特色卖点，例如：静音设计、智能控制、节能环保等" required></textarea>
                            </div>
                            
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="price" class="form-label fw-bold">价格</label>
                                        <input type="text" class="form-control" id="price" 
                                            placeholder="例如：299元、高端定位等">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label for="targetAudience" class="form-label fw-bold">目标用户</label>
                                        <input type="text" class="form-control" id="targetAudience" 
                                            placeholder="例如：年轻白领、学生群体等">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="channelType" class="form-label fw-bold">渠道类型 *</label>
                                <select class="form-select" id="channelType" required>
                                    <option value="">请选择渠道类型</option>
                                    <option value="poster">海报大图（竖版，含完整商品信息）</option>
                                    <option value="banner">Banner（横版，简约文案）</option>
                                    <option value="feed">信息流（无文字图片 + 配套文案）</option>
                                </select>
                                <div class="form-text mt-2">
                                    <strong>海报大图：</strong>竖版图片，包含完整商品信息<br>
                                    <strong>Banner：</strong>横版图片，简约文案<br>
                                    <strong>信息流：</strong>无文字图片 + 配套文案<br>
                                    <em class="text-muted">注：由于模型能力限制，海报和banner中的文字存在乱码现象，请谅解</em>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="additionalInfo" class="form-label fw-bold">其他信息</label>
                                <textarea class="form-control" id="additionalInfo" rows="2" 
                                    placeholder="品牌故事、使用场景、竞品优势等补充信息"></textarea>
                            </div>
                            

                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-magic me-2"></i>一键生成营销内容
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 生成结果展示 -->
                <div class="col-lg-12">
                    <div class="feature-card p-4 result-section" style="--animation-order: 2;">
                        <div class="text-center mb-4">
                            <i class="fas fa-image fa-2x text-primary mb-3"></i>
                            <h3 class="h4">生成结果</h3>
                            <p class="text-muted">AI生成的营销内容将在这里显示</p>
                        </div>
                        
                        <div class="result-area mt-3" id="result">
                            <div class="loading" id="loading" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">生成中...</span>
                                </div>
                                <p class="mt-2 text-muted">正在生成营销内容，请稍候...</p>
                            </div>
                            <div id="resultContent">
                                <p class="text-muted text-center">营销内容将在这里显示</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第三部分：效果分析 -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="feature-card p-4 analysis-section" style="--animation-order: 3;">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-primary">
                            <i class="fas fa-chart-line me-3"></i>
                            效果分析
                        </h3>
                        <p class="text-muted">上传用户行为数据，生成可视化分析报告</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">
                                    <i class="fas fa-upload me-2"></i>
                                    数据上传
                                </h5>
                                <form id="dataForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="dataFile" class="form-label">选择Excel文件</label>
                                        <input type="file" class="form-control" id="dataFile" name="file" accept=".xlsx,.xls">
                                        <div class="form-text">文件格式：user_id, date, price, click, purchase</div>
                                    </div>
                                    <div class="d-flex gap-3 align-items-center">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-chart-bar me-2"></i>
                                            开始分析
                                        </button>
                                        <button type="button" class="btn btn-outline-orange" onclick="useSampleData()">
                                            <i class="fas fa-download me-2"></i>
                                            体验样例数据
                                        </button>
                                        <a href="/download_sample" class="btn btn-outline-orange">
                                            <i class="fas fa-file-excel me-2"></i>
                                            下载样例
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    分析指标说明
                                </h5>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-primary">浏览量（PV）</h6>
                                                <small class="text-muted">每天访问的用户数</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-success">点击率</h6>
                                                <small class="text-muted">每天点击量/访问量</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-warning">转化率</h6>
                                                <small class="text-muted">每天购买量/点击量</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <div class="card border-0 bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-danger">GMV</h6>
                                                <small class="text-muted">每天购买量×当日单价</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="analysisLoading" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">分析中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在分析数据，请稍候...</p>
                    </div>

                    <div id="analysisResult" style="display: none;">
                        <div class="mb-4">
                            <h5 class="fw-bold text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                分析完成
                            </h5>
                            <div id="totalStats" class="row mb-4">
                                <!-- 总体统计将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 图表区域 -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-chart-line me-2"></i>
                                数据可视化
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary">每日浏览量（PV）</h6>
                                            <canvas id="pvChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-success">每日点击率</h6>
                                            <canvas id="clickRateChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-warning">每日转化率</h6>
                                            <canvas id="conversionRateChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-danger">每日GMV</h6>
                                            <canvas id="gmvChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数据表格 -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-table me-2"></i>
                                每日详细数据
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>日期</th>
                                            <th>浏览量(PV)</th>
                                            <th>点击量</th>
                                            <th>购买量</th>
                                            <th>单价(元)</th>
                                            <th>点击率</th>
                                            <th>转化率</th>
                                            <th>GMV(元)</th>
                                            <th>促销状态</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dataTableBody">
                                        <!-- 数据行将在这里显示 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const channelType = document.getElementById('channelType').value;
            const productName = document.getElementById('productName').value.trim();
            const productCategory = document.getElementById('productCategory').value.trim();
            const productFeatures = document.getElementById('productFeatures').value.trim();
            const price = document.getElementById('price').value.trim();
            const targetAudience = document.getElementById('targetAudience').value.trim();
            const additionalInfo = document.getElementById('additionalInfo').value.trim();
            
            if (!channelType) {
                alert('请选择渠道类型');
                return;
            }
            
            if (!productName || !productFeatures) {
                alert('请填写商品名称和主要功能/卖点');
                return;
            }
            
            const productInfo = {
                name: productName,
                category: productCategory,
                features: productFeatures,
                price: price,
                target_audience: targetAudience,
                additional_info: additionalInfo
            };
            
            const loading = document.getElementById('loading');
            const resultContent = document.getElementById('resultContent');
            
            loading.style.display = 'block';
            resultContent.innerHTML = '<p class="text-muted text-center">营销内容将在这里显示</p>';
            
            try {
                const response = await fetch('/generate_marketing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_info: productInfo,
                        channel_type: channelType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let resultHtml = '';
                    
                    // 显示渠道类型标签
                    const channelLabels = {
                        'poster': '海报大图',
                        'banner': 'Banner',
                        'feed': '信息流'
                    };
                    
                    resultHtml += `
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="text-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>生成成功
                                <span class="channel-badge channel-${channelType} ms-2">${channelLabels[channelType]}</span>
                            </h5>
                        </div>
                    `;
                    
                    // 根据渠道类型显示不同的结果格式
                    if (channelType === 'feed') {
                        // 信息流特殊展示：图片和文案在一个框内
                        if (data.image && data.image.success) {
                            resultHtml += `
                                <div class="mb-4">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-stream me-2"></i>信息流展示效果
                                    </h6>
                                                                         <div class="bg-white rounded border overflow-hidden" style="max-width: 400px; margin: 0 auto;">
                                         <div class="feed-image-container">
                                             <img src="${data.image.image_path}" alt="生成的图片" class="feed-image">
                                         </div>
                                        ${data.text && data.text.success ? `
                                            <div class="p-3 border-top">
                                                <p class="mb-2" style="font-size: 14px; color: #333; line-height: 1.4;">${data.text.content}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">信息流文案</small>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${data.text.content.replace(/'/g, "\\'")}')">
                                                        <i class="fas fa-copy me-1"></i>复制文案
                                                    </button>
                                                </div>
                                            </div>
                                        ` : ''}
                                        <div class="p-2 bg-light border-top">
                                            <a href="/download/${data.image.filename}" class="btn btn-sm btn-outline-secondary w-100">
                                                <i class="fas fa-download me-1"></i>下载图片
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (data.image && !data.image.success) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    图片生成失败：${data.image.error}
                                </div>
                            `;
                        }
                        
                        // 如果文案生成失败，单独显示错误
                        if (data.text && !data.text.success) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    文案生成失败：${data.text.error}
                                </div>
                            `;
                        }
                    } else {
                                                 // 其他渠道类型的常规展示
                         if (data.image && data.image.success) {
                             resultHtml += `
                                 <div class="mb-4">
                                     <h6 class="text-primary mb-2">
                                         <i class="fas fa-image me-2"></i>生成的图片
                                     </h6>
                                                                      <div class="text-center">
                                      <div class="image-container" style="display: inline-block; margin-bottom: 10px;">
                                          <img src="${data.image.image_path}" alt="生成的图片" class="generated-image">
                                      </div>
                                      <div class="mb-3">
                                             <a href="/download/${data.image.filename}" class="btn btn-sm btn-outline-primary me-2">
                                                 <i class="fas fa-download me-1"></i>下载图片
                                             </a>
                                             
                                         </div>
                                     </div>
                                 </div>
                             `;
                        } else if (data.image && !data.image.success) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    图片生成失败：${data.image.error}
                                </div>
                            `;
                        }
                        
                        // 显示文案结果（仅信息流类型）
                        if (data.text && data.text.success) {
                            resultHtml += `
                                <div class="mb-4">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-file-alt me-2"></i>配套文案
                                    </h6>
                                    <div class="bg-white p-3 rounded border">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${data.text.content}</pre>
                                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyToClipboard('${data.text.content.replace(/'/g, "\\'")}')">
                                                <i class="fas fa-copy me-1"></i>复制
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (data.text && !data.text.success) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    文案生成失败：${data.text.error}
                                </div>
                            `;
                        }
                    }
                    
                                         resultContent.innerHTML = resultHtml;
                    
                                 } else {
                     resultContent.innerHTML = `
                         <div class="text-center">
                             <i class="fas fa-exclamation-triangle text-danger fa-2x mb-3"></i>
                             <h5 class="text-danger">生成失败</h5>
                             <p class="text-muted">${data.error}</p>
                         </div>
                     `;
                 }
                
                         } catch (error) {
                 resultContent.innerHTML = `
                     <div class="text-center">
                         <i class="fas fa-exclamation-triangle text-danger fa-2x mb-3"></i>
                         <h5 class="text-danger">网络错误</h5>
                         <p class="text-muted">请检查网络连接后重试</p>
                     </div>
                 `;
             } finally {
                 loading.style.display = 'none';
             }
        });

                 function copyToClipboard(text) {
             navigator.clipboard.writeText(text).then(function() {
                 alert('已复制到剪贴板');
             }, function(err) {
                 console.error('复制失败: ', err);
                 alert('复制失败，请手动复制');
             });
         }

        // 数据分析相关函数
        document.getElementById('dataForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('dataFile');
            
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }
            
            await analyzeData(formData);
        });

        async function useSampleData() {
            const formData = new FormData();
            await analyzeData(formData);
        }

        // 全局变量存储图表实例
        let chartInstances = {
            pvChart: null,
            clickRateChart: null,
            conversionRateChart: null,
            gmvChart: null
        };

        async function analyzeData(formData) {
            const loading = document.getElementById('analysisLoading');
            const result = document.getElementById('analysisResult');
            const totalStats = document.getElementById('totalStats');
            const dataTableBody = document.getElementById('dataTableBody');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            
            // 销毁现有图表
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            try {
                const response = await fetch('/analyze_data', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 显示总体统计
                    const stats = data.total_stats;
                    totalStats.innerHTML = `
                        <div class="col-md-3">
                            <div class="card border-0 bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 class="fw-bold">${stats.total_pv.toLocaleString()}</h4>
                                    <small>总浏览量</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 class="fw-bold">${(stats.avg_click_rate * 100).toFixed(1)}%</h4>
                                    <small>平均点击率</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 class="fw-bold">${(stats.avg_conversion_rate * 100).toFixed(1)}%</h4>
                                    <small>平均转化率</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 bg-danger text-white">
                                <div class="card-body text-center">
                                    <h4 class="fw-bold">¥${stats.total_gmv.toLocaleString()}</h4>
                                    <small>总GMV</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-calendar me-2"></i>
                                数据时间范围：${stats.date_range}
                            </div>
                        </div>
                    `;
                    
                    // 创建图表
                    createCharts(data.daily_stats);
                    
                    // 显示数据表格
                    displayDataTable(data.daily_stats);
                    
                    result.style.display = 'block';
                } else {
                    alert('分析失败：' + data.error);
                }
            } catch (error) {
                console.error('分析错误:', error);
                alert('网络错误，请重试');
            } finally {
                loading.style.display = 'none';
            }
        }

        function createCharts(dailyStats) {
            // 格式化日期标签：只显示月-日，每两天显示一次
            const formatDateLabels = (dates) => {
                return dates.map((date, index) => {
                    if (index % 2 === 0) {
                        const dateObj = new Date(date);
                        return `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                    }
                    return '';
                });
            };

            const dates = dailyStats.map(item => item.date);
            const formattedLabels = formatDateLabels(dates);
            const pvData = dailyStats.map(item => item.pv);
            const clickRateData = dailyStats.map(item => item.click_rate * 100);
            const conversionRateData = dailyStats.map(item => item.conversion_rate * 100);
            const gmvData = dailyStats.map(item => item.gmv);
            const promotionData = dailyStats.map(item => item.is_promotion);

            // 创建促销期间背景插件
            const createPromotionBackgroundPlugin = () => {
                return {
                    id: 'promotionBackground',
                    beforeDraw: (chart) => {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        const xAxis = chart.scales.x;
                        
                        if (!xAxis) return;
                        
                        // 为促销期间添加背景色
                        promotionData.forEach((isPromotion, index) => {
                            if (isPromotion) {
                                const xPos = xAxis.getPixelForTick(index);
                                const barWidth = xAxis.width / dates.length;
                                
                                ctx.save();
                                ctx.fillStyle = 'rgba(255, 193, 7, 0.15)';
                                ctx.fillRect(
                                    xPos - barWidth/2, 
                                    chartArea.top, 
                                    barWidth, 
                                    chartArea.height
                                );
                                ctx.restore();
                            }
                        });
                    }
                };
            };

            // 浏览量图表
            chartInstances.pvChart = new Chart(document.getElementById('pvChart'), {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: '浏览量',
                        data: pvData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        }
                    }
                },
                plugins: [createPromotionBackgroundPlugin()]
            });

            // 点击率图表
            chartInstances.clickRateChart = new Chart(document.getElementById('clickRateChart'), {
                type: 'bar',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: '点击率(%)',
                        data: clickRateData,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [createPromotionBackgroundPlugin()]
            });

            // 转化率图表
            chartInstances.conversionRateChart = new Chart(document.getElementById('conversionRateChart'), {
                type: 'bar',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: '转化率(%)',
                        data: conversionRateData,
                        backgroundColor: 'rgba(255, 205, 86, 0.8)',
                        borderColor: 'rgb(255, 205, 86)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                },
                plugins: [createPromotionBackgroundPlugin()]
            });

            // GMV图表
            chartInstances.gmvChart = new Chart(document.getElementById('gmvChart'), {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: 'GMV(元)',
                        data: gmvData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        }
                    }
                },
                plugins: [createPromotionBackgroundPlugin()]
            });
        }

        function displayDataTable(dailyStats) {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            dailyStats.forEach(item => {
                const row = document.createElement('tr');
                const promotionBadge = item.is_promotion ? 
                    '<span class="badge bg-warning text-dark">促销</span>' : 
                    '<span class="badge bg-secondary">常规</span>';
                
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.pv.toLocaleString()}</td>
                    <td>${item.clicks.toLocaleString()}</td>
                    <td>${item.purchases.toLocaleString()}</td>
                    <td>¥${item.price.toFixed(2)}</td>
                    <td>${(item.click_rate * 100).toFixed(2)}%</td>
                    <td>${(item.conversion_rate * 100).toFixed(2)}%</td>
                    <td>¥${item.gmv.toFixed(2)}</td>
                    <td>${promotionBadge}</td>
                `;
                tableBody.appendChild(row);
            });
        }
         

    </script>
</body>
</html> 